# 川崎設備工業 業務管理システム マニュアル

## システム概要

川崎設備工業 業務管理システムは、建設・設備工事業向けの統合業務管理アプリケーションです。実行予算の作成から発注契約、支払伝票の処理、承認ワークフローまで、工事に関わる一連の業務をデジタル化します。

### 主な機能一覧

| 機能名 | 説明 |
|--------|------|
| ログイン | ユーザー認証とアカウント切り替え |
| ホーム（ダッシュボード） | 業務状況の概要表示 |
| 実行予算登録 | 工事の実行予算を登録・管理 |
| 実行予算書作成 | Excel形式で予算書を作成 |
| 発注契約 | 工事の発注・契約情報を管理 |
| 発注照会 | 発注データの検索・照会 |
| OCR読取 | 請求書のAI-OCR読取機能 |
| 支払伝票入力 | 支払伝票の作成・申請 |
| 振替伝票入力 | 振替伝票の作成・申請 |
| 承認 | 申請された書類の承認処理 |
| 申請履歴 | 過去の申請履歴の確認 |
| 保存履歴 | 保存したファイルの管理 |

---

## ログイン方法

### ログイン画面へのアクセス

アプリケーションにアクセスすると、最初にログイン画面が表示されます。

### デモユーザーでのログイン

デモ環境では以下の3名のユーザーが用意されています。

| ユーザー名 | 部署 | 役割 | ログインコード |
|------------|------|------|----------------|
| 田中 太郎 | 工事部 | 申請者（applicant） | 1234 |
| 鈴木 花子 | 設備課 | 申請者（applicant） | 5678 |
| 山田 部長 | 工事部 | 承認者（manager） | 9999 |

### ログイン手順

1. ログイン画面でユーザーを選択します
2. 4桁のログインコードを入力します（例：田中太郎なら「1234」）
3. 「ログイン」ボタンをクリックします
4. 認証に成功するとホーム画面に遷移します

### URLパラメータでのログイン

URLに `?user=1`、`?user=2`、`?user=3` を付けることで、それぞれ1番目、2番目、3番目のユーザーとして自動ログインできます。

### ログアウト方法

画面右上のユーザー情報の横にある「ログアウト」ボタンをクリックすると、ログアウトしてログイン画面に戻ります。

---

## ホーム画面（ダッシュボード）

### ホーム画面の概要

ログイン後に表示されるメイン画面です。業務に必要な各機能へのナビゲーションと、現在の業務状況の概要を確認できます。

### 画面構成

- **ヘッダー**: 「川崎設備工業」のロゴ、ログインユーザー情報、ログアウトボタン
- **タブナビゲーション**: 各機能への遷移タブ
- **パンくずリスト**: 現在の画面位置を表示
- **メインコンテンツ**: 選択した機能の内容

### タブナビゲーションの項目

| タブ名 | 遷移先 | 説明 |
|--------|--------|------|
| ホーム | / | ダッシュボード画面 |
| 実行予算 | /budget | 実行予算登録画面 |
| 発注 | /order-inquiry | 発注照会画面 |
| OCR読取 | /ocr | 請求書OCR読取画面 |
| 承認 | /approval | 承認処理画面（承認者のみアクティブ） |
| 履歴 | /history | 申請履歴画面 |
| ストレージ | /my-storage | 保存履歴画面 |

---

## 実行予算登録

### 実行予算登録画面の概要

工事の実行予算を登録・管理する画面です。工事コード、工事名称、予算明細（工種コード、工種名称、費目、実行予算）を入力して予算データを作成します。

### 画面へのアクセス

1. タブナビゲーションから「実行予算」をクリック
2. または URL: `/budget` に直接アクセス

### 入力項目

#### 基本情報
| 項目名 | 説明 | 入力例 |
|--------|------|--------|
| 工事コード | 工事を識別するコード | 2025-001 |
| 工事名称 | 工事の正式名称 | 〇〇ビル新築電気設備工事 |
| 予算作成日 | 予算書の作成日 | 2025/01/15 |

#### 予算明細（複数行入力可能）
| 項目名 | 説明 | 入力例 |
|--------|------|--------|
| No. | 明細の行番号（自動採番） | 00001 |
| 工種コード | 工種を識別するコード | A01 |
| 工種名称 | 工種の名称 | 電気工事 |
| 費目 | 費用の区分 | 材料費 |
| 実行予算 | 予算金額（円） | 5,000,000 |

### 操作方法

1. **行の追加**: 「行を追加」ボタンをクリックすると明細行が追加されます
2. **行の削除**: 各行の「削除」ボタンをクリックすると、その行が削除されます（最低1行は必要）
3. **合計金額**: 入力した実行予算の合計が自動計算されて表示されます
4. **申請**: 「申請」ボタンをクリックすると承認者への申請モーダルが開きます

### 申請の流れ

1. 「申請」ボタンをクリック
2. 申請モーダルで承認者を選択
3. 「申請する」ボタンをクリック
4. 申請完了メッセージが表示される

---

## 実行予算書作成（Excelエディタ）

### 実行予算書作成画面の概要

Excelライクなスプレッドシートエディタで予算書を作成・編集できる画面です。Univerライブラリを使用しており、Excelファイル（.xlsx）のインポート・エクスポートが可能です。

### 画面へのアクセス

1. URL: `/excel-make` に直接アクセス
2. または URL: `/excel-make?template=yosan` で予算書テンプレートを自動読み込み

### 機能一覧

| 機能 | 説明 |
|------|------|
| Excelファイルを開く | ローカルの.xlsx/.xlsファイルを読み込む |
| 自動保存 | 編集内容がLocalStorageに自動保存される |
| 印刷 | 印刷機能（準備中） |
| CSV出力 | CSV形式でエクスポート（準備中） |
| JSONエクスポート | スプレッドシートのスナップショットをJSON形式でダウンロード |
| 実行予算登録に移行 | 入力データを元に実行予算登録画面へ遷移 |

### 予算書テンプレートのデフォルト値

テンプレート読み込み時に以下のサンプルデータが自動入力されます：

| セル | 内容 | 値 |
|------|------|-----|
| A14 | 工番 | 2025-001 |
| M14 | 工事名称 | 〇〇ビル新築電気・空調設備工事 |
| AI14 | 着工日 | 2025/04/01 |
| AI15 | 竣工日 | 2026/03/31 |
| AQ14 | 期間 | 12ヶ月 |
| A17 | 受注形態 | 元請・一式請負 |
| L17 | 受注先名 | 株式会社サンプル建設（No. 015） |
| Y17 | 施主 | サンプル不動産株式会社 |
| AF17 | 設計事務所 | サンプル設計事務所一級建築士事務所 |
| AT17 | ゼネコン | 株式会社サンプル建設 |
| A20 | 建物用途 | 事務所ビル（地上10階・地下1階） |
| N20 | 受注金額/工期月数 | 10,000 / 12 |
| Y20 | 電気 | 6,000 |
| AF20 | 空調 | 2,500 |
| AM20 | 衛生 | 1,000 |

### 自動保存について

- 編集内容は1秒のデバウンス後にLocalStorageに自動保存されます
- 保存されたデータはブラウザを閉じても保持されます
- 画面右上に「自動保存: HH:MM:SS」と最終保存時刻が表示されます
- 保存データを削除したい場合は開発者ツールでLocalStorageをクリアしてください

---

## 発注契約

### 発注契約画面の概要

工事の発注・契約情報を管理する画面です。発注先、契約金額、契約条件などを入力して発注データを作成します。

### 画面へのアクセス

URL: `/order-contract` に直接アクセス

### 主な機能

- 発注情報の入力
- 契約書類のプレビュー
- 承認者への申請

---

## 発注照会

### 発注照会画面の概要

登録済みの発注データを検索・照会する画面です。工事コード、発注先、期間などの条件で絞り込み検索ができます。

### 画面へのアクセス

1. タブナビゲーションから「発注」をクリック
2. または URL: `/order-inquiry` に直接アクセス

### 検索条件

| 項目名 | 説明 |
|--------|------|
| 工事コード | 工事コードで検索 |
| 発注先 | 発注先名で検索 |
| 期間 | 発注日の期間指定 |
| ステータス | 発注状態で絞り込み |

---

## OCR読取

### OCR読取画面の概要

請求書などの書類をAI-OCR（光学文字認識）で読み取り、データを自動抽出する画面です。Azure Document Intelligenceを使用しています。

### 画面へのアクセス

1. タブナビゲーションから「OCR読取」をクリック
2. または URL: `/ocr` に直接アクセス

### 対応ファイル形式

- PDF形式（.pdf）
- 画像形式（.jpg, .jpeg, .png, .gif など）

### 操作手順

1. **ファイル選択**: ドラッグ＆ドロップまたはクリックでファイルを選択
2. **OCR解析**: 「OCR解析」ボタンをクリックしてAI解析を実行
3. **結果確認**: 抽出されたデータが右側パネルに表示される
4. **支払伝票入力に進む**: 抽出データを支払伝票に引き継いで遷移

### 抽出されるフィールド

| フィールド名 | 日本語名 | 説明 |
|--------------|----------|------|
| payeeCompanyName | 支払先会社名 | 請求元の会社名 |
| payeePostalCode | 支払先郵便番号 | 請求元の郵便番号 |
| payeeAddress | 支払先住所 | 請求元の住所 |
| payeePhoneNumber | 支払先電話番号 | 請求元の電話番号 |
| payeeEmailAddress | 支払先メールアドレス | 請求元のメールアドレス |
| bankName | 振込先銀行名 | 振込先の銀行名 |
| bankBranchName | 振込先銀行支店 | 振込先の支店名 |
| bankAccountType | 振込先口座種類 | 普通/当座など |
| bankAccountNumber | 振込先口座番号 | 口座番号 |
| payeeCompanyNameKana | 振込先会社名半角カナ | 振込用のカナ名 |
| paymentDueDate | 支払期限 | 支払期限日 |
| invoiceAmountFontMax | 請求額 | 請求金額 |
| subtotalAmount | 小計(税抜) | 税抜き小計金額 |
| consumptionTaxAmount | 消費税(10%) | 消費税額 |
| totalAmount | 合計(税込) | 税込み合計金額 |
| invoiceRegNo | 適格請求書発行事業者登録番号 | インボイス登録番号（T+13桁数字） |

### 明細行の抽出

請求書に明細がある場合、以下のフィールドが行ごとに抽出されます：

| フィールド名 | 日本語名 |
|--------------|----------|
| itemNo | No |
| itemDescription | 品目 |
| itemQuantity | 数量 |
| itemUnitPrice | 単価 |
| itemAmount | 金額 |

### バウンディングボックス表示

OCR結果では、検出された各フィールドの位置が色付きの枠で表示されます。右側のテーブルでフィールドにマウスオーバーすると、対応する位置がハイライトされます。

---

## 支払伝票入力

### 支払伝票入力画面の概要

支払伝票を作成・申請する画面です。OCR読取から引き継いだデータを編集したり、新規に支払情報を入力できます。

### 画面へのアクセス

1. OCR読取画面から「支払伝票入力に進む」をクリック
2. または URL: `/payment-slip` に直接アクセス

### ヘッダー情報

| 項目名 | 説明 | 備考 |
|--------|------|------|
| 伝票No. | 伝票の識別番号 | 自動採番 |
| 伝票日付 | 伝票の日付 | 日付選択 |
| 定時/臨時 | 支払区分 | 定時または臨時 |
| 参照元伝票 | 関連する元伝票 | ドロップダウン選択 |
| 支払先 | 支払先の会社名 | 支払先マスタから選択 |
| 支払管理部門 | 支払を管理する部門 | テキスト入力 |
| 支払条件 | 支払の条件 | 定時の場合は自動設定 |
| 支払先特記 | 特記事項 | テキスト入力 |
| 免税初期間 | 免税の開始期間 | ドロップダウン選択 |

### 支払明細

各明細行で入力する項目：

#### 1行目の項目
| 項目名 | 説明 |
|--------|------|
| 科目 | 勘定科目（サジェスト機能付き） |
| 免 | 免税チェックボックス |
| 取引先 | 取引先名 |
| JV負担区分 | JV工事の負担区分 |
| 費目 | 費用の種類 |
| 消税区分 | 内税/外税 |
| 査定金額 | 税込みの査定金額 |
| 立替税率 | 立替の税率 |
| 事業者登録番号 | 適格請求書発行事業者登録番号 |

#### 2行目の項目
| 項目名 | 説明 |
|--------|------|
| 部門 | 所属部門 |
| 工事 | 対象工事 |
| 引合物件 | 引合の物件 |
| 工種 | 工種 |
| 課税区分 | 標準(10%)/軽減(8%)/対象外 |
| 消費税額 | 消費税の金額 |
| 立替消費税 | 立替の消費税額 |
| JV負担先 / 摘要 | JV負担先と摘要を入力 |

### 金額サマリー

画面上部に3つのサマリーカードが表示されます：

| カード | 説明 | 計算方法 |
|--------|------|----------|
| 査定金額 | 税抜きの査定金額合計 | 税込み合計 - 消費税合計 |
| 消費税額 | 消費税の合計 | 各行の消費税額の合計 |
| 支払金額（税込） | 税込みの支払金額合計 | 各行の査定金額の合計 |

### 支払先マスタ

「選択」ボタンをクリックすると支払先マスタモーダルが開きます。
- 業者コード、業者名、業者名カナで検索可能
- 選択すると支払先と事業者登録番号が自動入力されます

### OCRデータの引き継ぎ

OCR読取画面から遷移した場合、以下のデータが自動入力されます：
- 支払先会社名 → 支払先
- 適格請求書発行事業者登録番号 → 事業者登録番号（全行に適用）
- 明細行（品目、金額など）

### 申請の流れ

1. 「申請」ボタンをクリック
2. 申請モーダルが開く
3. タブで請求書と支払伝票のプレビューを切り替え可能
4. 申請先（承認者）を選択
5. 「申請する」ボタンをクリック
6. 申請完了メッセージが表示される

### ショートカットキー

| キー | 機能 |
|------|------|
| F2 | 印刷 |
| F5 | 保存 |
| F12 | 検索 |

---

## 振替伝票入力

### 振替伝票入力画面の概要

振替伝票を作成・申請する画面です。勘定科目間の振替処理を入力します。

### 画面へのアクセス

1. 支払伝票入力画面から「振替伝票入力に進む」をクリック
2. または URL: `/transfer-slip` に直接アクセス

### 主な入力項目

- 伝票番号
- 伝票日付
- 借方科目・金額
- 貸方科目・金額
- 摘要

---

## 承認画面

### 承認画面の概要

承認者（manager）が申請された書類を承認または差戻しする画面です。

### 画面へのアクセス

1. タブナビゲーションから「承認」をクリック
2. または URL: `/approval` に直接アクセス

### アクセス権限

- **承認者（manager）のみ**: 承認処理が可能
- **申請者（applicant）**: 閲覧のみ（承認操作不可）

### 申請一覧の表示項目

| 項目 | 説明 |
|------|------|
| 申請日 | 申請が行われた日付 |
| 申請者 | 申請を行ったユーザー名 |
| 工事名 | 対象の工事名称またはタイトル |
| 種類 | 申請の種類（実行予算、支払伝票など） |
| ステータス | 申請中/承認済み/差戻し |

### 承認フロー

申請は以下の承認フローを経て処理されます：

1. **支店** → **支社** → **経理部** → **本社**

各ステップで承認されると次のステップに進みます。

### 承認・差戻し操作

1. 一覧から対象の申請を選択
2. 詳細モーダルで内容を確認
3. 「承認」または「差戻し」ボタンをクリック
4. 処理完了メッセージが表示される

### 添付書類のプレビュー

申請種類に応じて、以下の書類をプレビュー表示できます：

- **発注契約の場合**: 注文伺書、工事実行予算台帳、発注予定表
- **支払伝票の場合**: 請求書、支払伝票
- **実行予算書の場合**: 予算書PDF

---

## 申請履歴

### 申請履歴画面の概要

自分が過去に申請した書類の履歴を確認する画面です。

### 画面へのアクセス

1. タブナビゲーションから「履歴」をクリック
2. または URL: `/history` に直接アクセス

### フィルター機能

ステータスで絞り込みが可能です：

| フィルター値 | 説明 |
|--------------|------|
| すべて | 全ての申請を表示 |
| 申請中 | 承認待ちの申請 |
| 承認済み | 承認された申請 |
| 差戻し | 差戻しされた申請 |

### 表示項目

| 項目 | 説明 |
|------|------|
| 申請日 | 申請を行った日付 |
| 工事名 | 対象の工事名称またはタイトル |
| 種類 | 申請の種類 |
| 申請経路 | 承認フローの進捗状況 |
| ステータス | 現在の状態 |

### 詳細モーダル

「詳細」ボタンをクリックすると、申請の詳細情報が表示されます：

- 基本情報（申請種別、申請日、申請者、ステータス）
- 予算情報（実行予算の場合）
- 予算明細（実行予算の場合）
- 添付書類プレビュー

---

## 保存履歴（マイストレージ）

### 保存履歴画面の概要

ユーザーが保存したファイルを管理する画面です。

### 画面へのアクセス

1. タブナビゲーションから「ストレージ」をクリック
2. または URL: `/my-storage` に直接アクセス

### ファイル一覧の表示

| 項目 | 説明 |
|------|------|
| ファイルアイコン | ファイルタイプを示すアイコン（XLS/PDF/IMG） |
| ファイル名 | 保存されたファイルの名前 |
| サイズ | ファイルサイズ |
| 日付 | 保存日時 |

### ファイル操作

| 操作 | 説明 |
|------|------|
| DL（ダウンロード） | ファイルをダウンロード |
| 削除 | ファイルを削除（確認ダイアログあり） |
| 新規アップロード | 新しいファイルをアップロード |

---

## 勘定科目サジェスト機能

### 機能概要

支払伝票入力画面の「科目」フィールドでは、入力内容に応じて勘定科目の候補がサジェスト表示されます。

### サジェストの仕組み

1. 科目名を入力開始
2. 入力文字に一致する科目が候補として表示
3. 候補をクリックまたはキーボードで選択
4. 選択した科目が入力される

### 摘要からのAIサジェスト

摘要（summary）に入力した内容をもとに、AIが適切な勘定科目をサジェストします。

---

## マスタデータ

### 勘定科目マスタ

システムには勘定科目マスタが登録されており、支払伝票入力時にサジェスト候補として使用されます。

### 支払先マスタ

支払先（業者）のマスタデータが登録されており、以下の情報を含みます：

| 項目 | 説明 |
|------|------|
| 業者コード | 業者を識別するコード |
| 業者名 | 業者の正式名称 |
| 業者名カナ | 業者名のカタカナ表記 |
| 事業者登録番号 | 適格請求書発行事業者登録番号 |

---

## ユーザーロールと権限

### 申請者（applicant）

- 実行予算の登録・申請
- 支払伝票の作成・申請
- 振替伝票の作成・申請
- OCR読取の実行
- 自分の申請履歴の確認
- ファイルの保存・管理

### 承認者（manager）

- 申請者の全機能
- 申請された書類の承認
- 申請された書類の差戻し

---

## 画面遷移フロー

### 請求書処理の基本フロー

```
OCR読取 → 支払伝票入力 → 振替伝票入力 → 申請 → 承認
```

1. **OCR読取**: 請求書をアップロードしてOCR解析
2. **支払伝票入力**: OCR結果を元に支払伝票を作成
3. **振替伝票入力**: 必要に応じて振替伝票を作成
4. **申請**: 承認者に申請
5. **承認**: 承認者が内容を確認して承認または差戻し

### 予算作成の基本フロー

```
実行予算書作成（Excel） → 実行予算登録 → 申請 → 承認
```

1. **実行予算書作成**: Excelエディタで予算書を作成
2. **実行予算登録**: 予算データを登録
3. **申請**: 承認者に申請
4. **承認**: 承認者が内容を確認して承認または差戻し

---

## システム要件

### 対応ブラウザ

- Google Chrome（推奨）
- Microsoft Edge
- Firefox
- Safari

### 必要な環境

- インターネット接続
- JavaScript有効
- LocalStorage有効（Excel編集機能の自動保存に必要）

---

## トラブルシューティング

### ログインできない場合

1. 正しいログインコードを入力しているか確認してください
2. デモユーザーのコード: 1234, 5678, 9999
3. ブラウザのキャッシュをクリアして再試行してください

### OCR解析が失敗する場合

1. ファイル形式がPDFまたは画像であることを確認してください
2. ファイルサイズが大きすぎないか確認してください
3. 画像が鮮明であることを確認してください

### Excelファイルが読み込めない場合

1. Univer Serverが起動しているか確認してください
2. .xlsx形式のファイルを使用してください
3. ブラウザのコンソールでエラーを確認してください

### 自動保存データを削除したい場合

1. ブラウザの開発者ツールを開く（F12）
2. Application → Local Storage を選択
3. `kawasaki-excel-snapshot` キーを削除

---

## よくある質問（FAQ）

### Q: デモユーザーのログインコードは何ですか？

A:
- 田中太郎: 1234
- 鈴木花子: 5678
- 山田部長: 9999

### Q: 承認機能を使うにはどうすればいいですか？

A: 承認者ロールを持つユーザー（山田部長：コード9999）でログインしてください。

### Q: OCRで読み取れるファイル形式は何ですか？

A: PDFファイルと画像ファイル（JPG, PNG, GIFなど）に対応しています。

### Q: 支払伝票の科目はどうやって入力しますか？

A: 科目フィールドに文字を入力すると、登録されている勘定科目からサジェストが表示されます。また、摘要に入力した内容からAIが科目を推測することもできます。

### Q: 支払先はどうやって選択しますか？

A: 支払先フィールドの横にある「選択」ボタンをクリックすると、支払先マスタモーダルが開きます。検索して選択すると、支払先名と事業者登録番号が自動入力されます。

### Q: 申請した後の状態はどこで確認できますか？

A: タブナビゲーションの「履歴」をクリックすると、申請履歴画面で確認できます。

### Q: 実行予算書のExcelデータは保存されますか？

A: はい、編集内容はLocalStorageに自動保存されます。ブラウザを閉じても次回アクセス時に復元されます。

---

## 用語集

| 用語 | 説明 |
|------|------|
| 実行予算 | 工事を実施するために必要な予算 |
| 工種 | 工事の種類・区分 |
| 費目 | 費用の項目・区分 |
| 勘定科目 | 会計上の分類項目 |
| 査定金額 | 審査・評価された金額 |
| 免税 | 消費税が免除されること |
| 適格請求書発行事業者登録番号 | インボイス制度における登録番号（T+13桁数字） |
| JV | Joint Venture（共同企業体） |
| 内税 | 税込み表示 |
| 外税 | 税抜き表示 |

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025/01/17 | 初版作成 |

---

## お問い合わせ

システムに関するお問い合わせは、システム管理者までご連絡ください。
